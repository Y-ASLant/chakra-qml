# 无边框窗口圆角实现技术文档

## 概述

在 Qt/QML 中，无边框窗口（`Qt.FramelessWindowHint`）无法使用 Windows DWM API 实现圆角，因为 DWM 圆角只对有系统边框的窗口生效。

本项目使用 **QML 层遮罩（Layer Mask）** 技术实现窗口圆角。

## 实现原理

```
┌─────────────────────────────────────────┐
│       ApplicationWindow (背景透明)      │
│  ┌─────────────────────────────────────┐│
│  │   contentWrapper (layer.enabled)    ││
│  │  ┌─────────────────────────────────┐││
│  │  │    MultiEffect (maskEnabled)    │││
│  │  │  ┌─────────────────────────────┐│││
│  │  │  │  圆角 Rectangle 作为遮罩    ││││
│  │  │  └─────────────────────────────┘│││
│  │  └─────────────────────────────────┘││
│  └─────────────────────────────────────┘│
└─────────────────────────────────────────┘
```

### 核心步骤

1. **窗口背景透明** - 让圆角区域外的部分透明
2. **离屏渲染** - 将所有内容渲染到 GPU 纹理
3. **遮罩裁剪** - 使用圆角矩形作为遮罩，裁剪掉四角

## 代码实现

### Main.qml

```qml
ApplicationWindow {
    id: root
    flags: Qt.Window | Qt.FramelessWindowHint
    
    // 1. 窗口背景透明
    color: "transparent"
    
    // 圆角半径
    readonly property int windowRadius: 8

    Item {
        id: contentWrapper
        anchors.fill: parent
        
        // 2. 启用离屏渲染
        layer.enabled: true
        layer.smooth: true
        
        // 3. 应用遮罩效果
        layer.effect: MultiEffect {
            maskEnabled: true
            maskThresholdMin: 0.5      // 平滑边缘
            maskSpreadAtMin: 1.0       // 边缘过渡
            maskSource: ShaderEffectSource {
                sourceItem: Rectangle {
                    width: contentWrapper.width
                    height: contentWrapper.height
                    radius: windowRadius
                    antialiasing: true  // 抗锯齿
                    smooth: true
                }
            }
        }

        // 4. 圆角背景色
        Rectangle {
            id: windowBg
            anchors.fill: parent
            radius: windowRadius
            color: theme.primaryColor
            z: -2
        }

        // ... 其他窗口内容 ...
    }
}
```

## 关键属性说明

| 属性 | 作用 |
|------|------|
| `color: "transparent"` | 让窗口背景透明，圆角外区域不可见 |
| `layer.enabled: true` | 启用离屏渲染，将内容渲染到 FBO 纹理 |
| `layer.smooth: true` | 启用双线性过滤，平滑缩放 |
| `maskEnabled: true` | 启用遮罩功能 |
| `maskThresholdMin: 0.5` | 遮罩阈值，影响边缘平滑度 |
| `maskSpreadAtMin: 1.0` | 边缘扩散，配合阈值实现抗锯齿 |
| `antialiasing: true` | Rectangle 抗锯齿 |

## 抗锯齿优化

### 基础抗锯齿
```qml
Rectangle {
    antialiasing: true
    smooth: true
}
```

### 增强抗锯齿（多重采样）
```qml
layer.enabled: true
layer.smooth: true
layer.samples: 4  // 4x MSAA，值越大效果越好但性能开销越大
```

### 遮罩边缘平滑
```qml
MultiEffect {
    maskThresholdMin: 0.5
    maskSpreadAtMin: 1.0
}
```

## 性能影响

| 特性 | 开销 | 说明 |
|------|------|------|
| `layer.enabled` | 中 | 额外的渲染通道 + GPU 纹理内存 |
| `layer.smooth` | 极低 | GPU 硬件加速 |
| `layer.samples` | 高 | 每增加采样数，GPU 负担成倍增加 |
| `MultiEffect` | 低 | 简单的着色器计算 |

### 建议配置

- **高端设备**：可启用 `layer.samples: 4` 或更高
- **普通设备**：使用 `maskThresholdMin` + `maskSpreadAtMin` 替代多重采样
- **低端设备**：只使用 `antialiasing: true`

## 注意事项

1. **必须使用无边框窗口** - `flags: Qt.Window | Qt.FramelessWindowHint`
2. **窗口背景必须透明** - `color: "transparent"`
3. **遮罩层组件也需要圆角** - 如弹窗遮罩层需匹配窗口圆角
4. **Windows DWM API 不适用** - 仅对有系统边框的窗口生效

## 其他组件的圆角

### EBlurCard（毛玻璃卡片）

使用相同的 MultiEffect 遮罩技术：

```qml
Item {
    id: maskItem
    layer.enabled: true
    layer.smooth: true
    visible: false
    Rectangle {
        radius: borderRadius
        antialiasing: true
        smooth: true
    }
}

MultiEffect {
    maskEnabled: true
    maskThresholdMin: 0.5
    maskSpreadAtMin: 1.0
    maskSource: maskItem
}
```

## 参考资料

- [Qt MultiEffect 文档](https://doc.qt.io/qt-6/qml-qtquick-effects-multieffect.html)
- [Qt Layer 文档](https://doc.qt.io/qt-6/qml-qtquick-item.html#layer.enabled-prop)
